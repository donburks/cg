<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head><body><div class="line-gutter-backdrop"></div><table><tbody><tr><td class="line-number" value="1"></td><td class="line-content"><span class="html-doctype">&lt;!DOCTYPE html&gt;</span></td></tr><tr><td class="line-number" value="2"></td><td class="line-content"><span class="html-tag">&lt;html <span class="html-attribute-name">lang</span>="<span class="html-attribute-value">en</span>"&gt;</span></td></tr><tr><td class="line-number" value="3"></td><td class="line-content">    <span class="html-tag">&lt;head&gt;</span></td></tr><tr><td class="line-number" value="4"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="5"></td><td class="line-content">        <span class="html-tag">&lt;meta <span class="html-attribute-name">charset</span>="<span class="html-attribute-value">UTF-8</span>"&gt;</span></td></tr><tr><td class="line-number" value="6"></td><td class="line-content">        <span class="html-tag">&lt;link <span class="html-attribute-name">rel</span>="<span class="html-attribute-value">stylesheet</span>" <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="http://mewo2.com/style.css">/style.css</a>" /&gt;</span></td></tr><tr><td class="line-number" value="7"></td><td class="line-content">        <span class="html-tag">&lt;link <span class="html-attribute-name">href</span>='<a class="html-attribute-value html-resource-link" target="_blank" href="https://fonts.googleapis.com/css?family=Raleway:400,700">https://fonts.googleapis.com/css?family=Raleway:400,700</a>' <span class="html-attribute-name">rel</span>='<span class="html-attribute-value">stylesheet</span>' <span class="html-attribute-name">type</span>='<span class="html-attribute-value">text/css</span>'&gt;</span></td></tr><tr><td class="line-number" value="8"></td><td class="line-content">        <span class="html-tag">&lt;title&gt;</span></td></tr><tr><td class="line-number" value="9"></td><td class="line-content">Generating fantasy maps</td></tr><tr><td class="line-number" value="10"></td><td class="line-content"><span class="html-tag">&lt;/title&gt;</span></td></tr><tr><td class="line-number" value="11"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="12"></td><td class="line-content">    <span class="html-tag">&lt;/head&gt;</span></td></tr><tr><td class="line-number" value="13"></td><td class="line-content">    <span class="html-tag">&lt;body&gt;</span></td></tr><tr><td class="line-number" value="14"></td><td class="line-content">        <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">content</span>"&gt;</span></td></tr><tr><td class="line-number" value="15"></td><td class="line-content"><span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">splash</span>"&gt;</span></td></tr><tr><td class="line-number" value="16"></td><td class="line-content">    <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://mewo2.com/">/</a>"&gt;</span>Home<span class="html-tag">&lt;/a&gt;</span></td></tr><tr><td class="line-number" value="17"></td><td class="line-content">    <span class="html-tag">&lt;h1&gt;</span>Generating fantasy maps<span class="html-tag">&lt;/h1&gt;</span></td></tr><tr><td class="line-number" value="18"></td><td class="line-content"><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="19"></td><td class="line-content"><span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">note</span>"&gt;</span></td></tr><tr><td class="line-number" value="20"></td><td class="line-content">    <span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="http://mewo2.com/js/d3.v4.js">/js/d3.v4.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="21"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="22"></td><td class="line-content"><span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="http://mewo2.com/js/priority-queue.js">/js/priority-queue.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="23"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="24"></td><td class="line-content"><span class="html-tag">&lt;style&gt;</span></td></tr><tr><td class="line-number" value="25"></td><td class="line-content">    path, line {</td></tr><tr><td class="line-number" value="26"></td><td class="line-content">        fill: none;</td></tr><tr><td class="line-number" value="27"></td><td class="line-content">        stroke: black;</td></tr><tr><td class="line-number" value="28"></td><td class="line-content">        stroke-linecap: round;</td></tr><tr><td class="line-number" value="29"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="30"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="31"></td><td class="line-content">    .field {</td></tr><tr><td class="line-number" value="32"></td><td class="line-content">        stroke: none;</td></tr><tr><td class="line-number" value="33"></td><td class="line-content">        fill-opacity: 1.0;</td></tr><tr><td class="line-number" value="34"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="35"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="36"></td><td class="line-content">    .slope {</td></tr><tr><td class="line-number" value="37"></td><td class="line-content">        stroke-width: 1;</td></tr><tr><td class="line-number" value="38"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="39"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="40"></td><td class="line-content">    .river {</td></tr><tr><td class="line-number" value="41"></td><td class="line-content">        stroke-width: 2;</td></tr><tr><td class="line-number" value="42"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="43"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="44"></td><td class="line-content">    .coast {</td></tr><tr><td class="line-number" value="45"></td><td class="line-content">        stroke-width: 4;</td></tr><tr><td class="line-number" value="46"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="47"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="48"></td><td class="line-content">    .border {</td></tr><tr><td class="line-number" value="49"></td><td class="line-content">        stroke-width: 5;</td></tr><tr><td class="line-number" value="50"></td><td class="line-content">        stroke-dasharray: 4,4;</td></tr><tr><td class="line-number" value="51"></td><td class="line-content">        stroke-linecap: butt;</td></tr><tr><td class="line-number" value="52"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="53"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="54"></td><td class="line-content">    text {</td></tr><tr><td class="line-number" value="55"></td><td class="line-content">        font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;</td></tr><tr><td class="line-number" value="56"></td><td class="line-content">        color: black;</td></tr><tr><td class="line-number" value="57"></td><td class="line-content">        stroke: white;</td></tr><tr><td class="line-number" value="58"></td><td class="line-content">        stroke-width: 5;</td></tr><tr><td class="line-number" value="59"></td><td class="line-content">        stroke-linejoin: round;</td></tr><tr><td class="line-number" value="60"></td><td class="line-content">        paint-order: stroke;</td></tr><tr><td class="line-number" value="61"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="62"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="63"></td><td class="line-content">    text.region {</td></tr><tr><td class="line-number" value="64"></td><td class="line-content">        stroke-width:10;</td></tr><tr><td class="line-number" value="65"></td><td class="line-content">        font-variant: small-caps;</td></tr><tr><td class="line-number" value="66"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="67"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="68"></td><td class="line-content">    svg {</td></tr><tr><td class="line-number" value="69"></td><td class="line-content">        float: right;</td></tr><tr><td class="line-number" value="70"></td><td class="line-content">        background-color: white;</td></tr><tr><td class="line-number" value="71"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="72"></td><td class="line-content"><span class="html-tag">&lt;/style&gt;</span></td></tr><tr><td class="line-number" value="73"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="74"></td><td class="line-content"><span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="http://mewo2.com/js/language.js">/js/language.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="75"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="76"></td><td class="line-content"><span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="http://mewo2.com/js/terrain.js">/js/terrain.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="77"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="78"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span><span class="html-tag">&lt;img <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="http://mewo2.com/deserts/map.png">/deserts/map.png</a>" <span class="html-attribute-name">alt</span>="<span class="html-attribute-value">An example map from the generator</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">float: right;</span>" <span class="html-attribute-name">width</span>="<span class="html-attribute-value">60%</span>"&gt;</span><span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="79"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>These are some notes on how I generate the maps for my Twitter bot</td></tr><tr><td class="line-number" value="80"></td><td class="line-content"><span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://twitter.com/unchartedatlas">https://twitter.com/unchartedatlas</a>"&gt;</span>@unchartedatlas<span class="html-tag">&lt;/a&gt;</span>, which is based on a generator I originally produced</td></tr><tr><td class="line-number" value="81"></td><td class="line-content">during <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://github.com/dariusk/NaNoGenMo-2015/issues/156">https://github.com/dariusk/NaNoGenMo-2015/issues/156</a>"&gt;</span>NaNoGenMo 2015<span class="html-tag">&lt;/a&gt;</span>. There's JavaScript code for the generator</td></tr><tr><td class="line-number" value="82"></td><td class="line-content">on Github <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://github.com/mewo2/terrain">https://github.com/mewo2/terrain</a>"&gt;</span>here<span class="html-tag">&lt;/a&gt;</span>, and the original messy Python generator code can be</td></tr><tr><td class="line-number" value="83"></td><td class="line-content">seen <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://github.com/mewo2/deserts">https://github.com/mewo2/deserts</a>"&gt;</span>here<span class="html-tag">&lt;/a&gt;</span>.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="84"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>You may also be interested in this <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://mewo2.com/notes/naming-language/">/notes/naming-language/</a>"&gt;</span>companion piece<span class="html-tag">&lt;/a&gt;</span>, which describes</td></tr><tr><td class="line-number" value="85"></td><td class="line-content">the placename generation.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="86"></td><td class="line-content"><span class="html-tag">&lt;h3&gt;</span>Inspiration<span class="html-tag">&lt;/h3&gt;</span></td></tr><tr><td class="line-number" value="87"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>I wanted to make maps that look like something you'd find at the back of one of</td></tr><tr><td class="line-number" value="88"></td><td class="line-content">the cheap paperback fantasy novels of my youth. I always had a fascination with</td></tr><tr><td class="line-number" value="89"></td><td class="line-content">these imagined worlds, which were often much more interesting than whatever</td></tr><tr><td class="line-number" value="90"></td><td class="line-content">luke-warm sub-Tolkien tale they were attached to.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="91"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>At the same time, I wanted to play with terrain generation with a physical</td></tr><tr><td class="line-number" value="92"></td><td class="line-content">basis. There are loads of articles on the internet which describe terrain</td></tr><tr><td class="line-number" value="93"></td><td class="line-content">generation, and they almost all use some variation on a fractal noise approach,</td></tr><tr><td class="line-number" value="94"></td><td class="line-content">either directly (by adding layers of noise functions), or indirectly (e.g.</td></tr><tr><td class="line-number" value="95"></td><td class="line-content">through midpoint displacement). These methods produce lots of fine detail, but</td></tr><tr><td class="line-number" value="96"></td><td class="line-content">the large-scale structure always looks a bit off. Features are attached in</td></tr><tr><td class="line-number" value="97"></td><td class="line-content">random ways, with no thought to the processes which form landscapes. I wanted</td></tr><tr><td class="line-number" value="98"></td><td class="line-content">to try something a little bit different.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="99"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>There are a few different stages to the generator. First we build up a</td></tr><tr><td class="line-number" value="100"></td><td class="line-content">height-map of the terrain, and do things like routing water flow over the</td></tr><tr><td class="line-number" value="101"></td><td class="line-content">surface. Then we can render the 'physical' portion of the map. Finally we can</td></tr><tr><td class="line-number" value="102"></td><td class="line-content">place cities and 'regions' on the map, and place their labels.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="103"></td><td class="line-content"><span class="html-tag">&lt;h3&gt;</span>Grids<span class="html-tag">&lt;/h3&gt;</span></td></tr><tr><td class="line-number" value="104"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>To represent the heightmap, first we need a grid of points. Although it can be</td></tr><tr><td class="line-number" value="105"></td><td class="line-content">simpler to work on a regular square grid, I much prefer to work on an irregular</td></tr><tr><td class="line-number" value="106"></td><td class="line-content">set of points for something like this. With a regular grid, it's very easy to</td></tr><tr><td class="line-number" value="107"></td><td class="line-content">run into weird artifacts, and you often have to do a lot of postprocessing to</td></tr><tr><td class="line-number" value="108"></td><td class="line-content">hide the effects of the grid. If you use an irregular grid, then there are a</td></tr><tr><td class="line-number" value="109"></td><td class="line-content">few things which are more complicated, but the structure of the grid helps to</td></tr><tr><td class="line-number" value="110"></td><td class="line-content">give the map a rough, organic feel, and you never have to worry about nasty</td></tr><tr><td class="line-number" value="111"></td><td class="line-content">linear artifacts in the finished product.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="112"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>The approach I use is the same as in <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://www-cs-students.stanford.edu/~amitp/game-programming/polygon-map-generation/">http://www-cs-students.stanford.edu/~amitp/game-programming/polygon-map-generation/</a>"&gt;</span>this article<span class="html-tag">&lt;/a&gt;</span>, which is one of the</td></tr><tr><td class="line-number" value="113"></td><td class="line-content">better references out there on how to do non-fractal terrain generation. I</td></tr><tr><td class="line-number" value="114"></td><td class="line-content">won't go into too much detail here because that article explains it very</td></tr><tr><td class="line-number" value="115"></td><td class="line-content">clearly, with lots of diagrams.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="116"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>I start by selecting points at random within the map. These points tend to be a</td></tr><tr><td class="line-number" value="117"></td><td class="line-content">bit clumpy and uneven, so I use <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://en.wikipedia.org/wiki/Lloyd%27s_algorithm">https://en.wikipedia.org/wiki/Lloyd%27s_algorithm</a>"&gt;</span>Lloyd relaxation<span class="html-tag">&lt;/a&gt;</span> to improve the point</td></tr><tr><td class="line-number" value="118"></td><td class="line-content">set. For speed, I only use one iteration of this process, but you can repeat it</td></tr><tr><td class="line-number" value="119"></td><td class="line-content">as many times as you like. There are rapidly diminishing returns after a few</td></tr><tr><td class="line-number" value="120"></td><td class="line-content">iterations though.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="121"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>All of the calculations are actually carried out on the 'dual points' of the</td></tr><tr><td class="line-number" value="122"></td><td class="line-content">original point set, which correspond to the corners of the Voronoi polygons.</td></tr><tr><td class="line-number" value="123"></td><td class="line-content">This has the advantage that the number of neighbours per node is fixed at</td></tr><tr><td class="line-number" value="124"></td><td class="line-content">three, which helps in some parts of the code.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="125"></td><td class="line-content"><span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">example</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">mesh</span>"&gt;</span></td></tr><tr><td class="line-number" value="126"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>Note: this shows 256 (2<span class="html-tag">&lt;sup&gt;</span>8<span class="html-tag">&lt;/sup&gt;</span>) points, to make viewing easier, but the real generator uses 16,384 (2<span class="html-tag">&lt;sup&gt;</span>14<span class="html-tag">&lt;/sup&gt;</span>) points. I have a programmer's superstitions about always using powers of 2, which are more pleasing to the spirit of the machine.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="127"></td><td class="line-content"><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="128"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="129"></td><td class="line-content"><span class="html-tag">&lt;h3&gt;</span>Rough outlines<span class="html-tag">&lt;/h3&gt;</span></td></tr><tr><td class="line-number" value="130"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>One of the difficulties of creating landscapes in a realistic way is that real</td></tr><tr><td class="line-number" value="131"></td><td class="line-content">landscapes aren't created all at once. Instead, they evolve from earlier</td></tr><tr><td class="line-number" value="132"></td><td class="line-content">landscapes, which in turn evolved from even earlier landscapes, and so on back</td></tr><tr><td class="line-number" value="133"></td><td class="line-content">for billions of years. There's no good way to simulate this process in a</td></tr><tr><td class="line-number" value="134"></td><td class="line-content">reasonable amount of time, so we need to cheat slightly.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="135"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>Rather than an infinite regress of older landscapes, I start with a simple</td></tr><tr><td class="line-number" value="136"></td><td class="line-content">'proto-landscape', built with geometric primitives. This lets me control the</td></tr><tr><td class="line-number" value="137"></td><td class="line-content">broad outlines of the terrain, while leaving the details for the more physical</td></tr><tr><td class="line-number" value="138"></td><td class="line-content">processes to fill in later.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="139"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>Some useful primitives which we can add together:<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="140"></td><td class="line-content"><span class="html-tag">&lt;ul&gt;</span></td></tr><tr><td class="line-number" value="141"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Constant slope - if you want to pretend this is physically motivated, think of it as tectonic uplift on one side of the map<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="142"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Cone shapes - these can be islands or mountains, or if inverted, lakes or seas<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="143"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Rounded blobs - these make better hills, and can be scattered all around to make a noisy surface<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="144"></td><td class="line-content"><span class="html-tag">&lt;/ul&gt;</span></td></tr><tr><td class="line-number" value="145"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>We also have a few operations which are handy:<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="146"></td><td class="line-content"><span class="html-tag">&lt;ul&gt;</span></td></tr><tr><td class="line-number" value="147"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Normalize - rescale the heights to lie in the range 0-1<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="148"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Round - normalize, then take the square root of the height value, to round off the tops of hills<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="149"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Relax - replace each height value with the average of its neighbours, to smooth the surface<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="150"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Set sea level - translate the heightmap up or down so that a particular quantile is at zero<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="151"></td><td class="line-content"><span class="html-tag">&lt;/ul&gt;</span></td></tr><tr><td class="line-number" value="152"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>The particular sequence of primitives and operations used can be varied to produce different kinds of landscape, such as coastlines, islands and mountain ranges.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="153"></td><td class="line-content"><span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">example</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">prim</span>"&gt;</span></td></tr><tr><td class="line-number" value="154"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>Note: the black line indicates the zero contour, which we treat as 'sea level'. Also, this map uses 4,096 (2<span class="html-tag">&lt;sup&gt;</span>12<span class="html-tag">&lt;/sup&gt;</span>) points, for speed.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="155"></td><td class="line-content"><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="156"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="157"></td><td class="line-content"><span class="html-tag">&lt;h3&gt;</span>Erosion<span class="html-tag">&lt;/h3&gt;</span></td></tr><tr><td class="line-number" value="158"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>The results of this process can be a little bit on the blobby side, which means</td></tr><tr><td class="line-number" value="159"></td><td class="line-content">they rarely look good on their own. We want to scuff them up a bit, so they</td></tr><tr><td class="line-number" value="160"></td><td class="line-content">look more like real landscapes. We do this by applying an erosion operation.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="161"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>In most of the world, by far the largest influence on the shape of landforms is</td></tr><tr><td class="line-number" value="162"></td><td class="line-content">fluvial (water-based) erosion. Water flows downhill, carrying sediment along</td></tr><tr><td class="line-number" value="163"></td><td class="line-content">with it, carving out valleys and river basins. This is a massively complex</td></tr><tr><td class="line-number" value="164"></td><td class="line-content">phenomenon, and modelling it correctly is a very active research area, but we</td></tr><tr><td class="line-number" value="165"></td><td class="line-content">can get a long way by sketching a simple version of the process.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="166"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>We need to start by tracing the routes that water would take over the grid. For</td></tr><tr><td class="line-number" value="167"></td><td class="line-content">each grid point, we say that water flows to its lowest neighbour, and so on</td></tr><tr><td class="line-number" value="168"></td><td class="line-content">down until we reach the edge of the map. This gives a map of water flow.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="169"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>There's an obvious problem when we reach gridpoints which are lower than all of</td></tr><tr><td class="line-number" value="170"></td><td class="line-content">their neighbours. Do we route the water back uphill? This will probably lead to</td></tr><tr><td class="line-number" value="171"></td><td class="line-content">cycles in the water system, which are trouble. Instead, we want to fill in</td></tr><tr><td class="line-number" value="172"></td><td class="line-content">these gaps (often called sinks or depressions), so that the water always runs</td></tr><tr><td class="line-number" value="173"></td><td class="line-content">downhill all the way to the edge.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="174"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>It's easy to see how to fill in a single gridpoint, but as the depression gets</td></tr><tr><td class="line-number" value="175"></td><td class="line-content">bigger, and possibly links up with other depressions, the number of possible</td></tr><tr><td class="line-number" value="176"></td><td class="line-content">cases multiplies enormously. Luckily, there's an algorithm for filling</td></tr><tr><td class="line-number" value="177"></td><td class="line-content">depressions, called the Planchon-Darboux algorithm.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="178"></td><td class="line-content"><span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">example</span>"&gt;</span></td></tr><tr><td class="line-number" value="179"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="180"></td><td class="line-content"><span class="html-tag">&lt;h4&gt;</span>Aside: the Planchon-Darboux algorithm<span class="html-tag">&lt;/h4&gt;</span></td></tr><tr><td class="line-number" value="181"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="182"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>The algorithm works by finding the lowest surface with the following two properties:<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="183"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="184"></td><td class="line-content"><span class="html-tag">&lt;ul&gt;</span></td></tr><tr><td class="line-number" value="185"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>The surface is everywhere at least as high as the input surface<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="186"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Every non-edge point has a neighbour which is lower than it<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="187"></td><td class="line-content"><span class="html-tag">&lt;/ul&gt;</span></td></tr><tr><td class="line-number" value="188"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="189"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>To calculate this, we start with an infinitely high surface everywhere</td></tr><tr><td class="line-number" value="190"></td><td class="line-content">except on the edge, where we use the original heights. Then, on each iteration,</td></tr><tr><td class="line-number" value="191"></td><td class="line-content">we find points which have a neighbour which is lower than them, and set their</td></tr><tr><td class="line-number" value="192"></td><td class="line-content">height to their original height, or the height of their lowest neighbour (plus</td></tr><tr><td class="line-number" value="193"></td><td class="line-content">a small amount), whichever is higher. We halt when we can go a full iteration</td></tr><tr><td class="line-number" value="194"></td><td class="line-content">without changing any point.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="195"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="196"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>There are various ways of speeding up this algorithm, mostly by tweaking the</td></tr><tr><td class="line-number" value="197"></td><td class="line-content">order in which points are visited. For more details, and a proof of</td></tr><tr><td class="line-number" value="198"></td><td class="line-content">correctness, you can read <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://horizon.documentation.ird.fr/exl-doc/pleins_textes/pleins_textes_7/sous_copyright/010031925.pdf">http://horizon.documentation.ird.fr/exl-doc/pleins_textes/pleins_textes_7/sous_copyright/010031925.pdf</a>"&gt;</span>the original paper<span class="html-tag">&lt;/a&gt;</span>.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="199"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="200"></td><td class="line-content"><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="201"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="202"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>With the water routing calculated, we can work out how much water is flowing</td></tr><tr><td class="line-number" value="203"></td><td class="line-content">through each point. I assume that rainfall is constant across the whole map,</td></tr><tr><td class="line-number" value="204"></td><td class="line-content">and iterate through the points in descending order, passing the rainfall, plus</td></tr><tr><td class="line-number" value="205"></td><td class="line-content">the accumulated water flux, from each point to its 'downhill point'. This gives</td></tr><tr><td class="line-number" value="206"></td><td class="line-content">a map of water flux, which usually converges into a nice branching river</td></tr><tr><td class="line-number" value="207"></td><td class="line-content">structure, with lots of small streams feeding a larger central channel.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="208"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>To calculate erosion, I combine the water flux with the slope at each point, as</td></tr><tr><td class="line-number" value="209"></td><td class="line-content">calculated based on the triangle of its neighbours. The exact formula I use is</td></tr><tr><td class="line-number" value="210"></td><td class="line-content">the product of the slope with the square root of the water flux. This isn't</td></tr><tr><td class="line-number" value="211"></td><td class="line-content">necessarily very physical, but it does give nice-looking results. I also add a</td></tr><tr><td class="line-number" value="212"></td><td class="line-content">small term which is proportional to the slope squared. This prevents deep</td></tr><tr><td class="line-number" value="213"></td><td class="line-content">gorges from forming, which might be physically realistic, but don't look good</td></tr><tr><td class="line-number" value="214"></td><td class="line-content">in the graphical style I've chosen.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="215"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>I find it's very important to cap the erosion rate, otherwise strange things</td></tr><tr><td class="line-number" value="216"></td><td class="line-content">can happen. A little goes a very long way with this. Also, erosion always</td></tr><tr><td class="line-number" value="217"></td><td class="line-content">lowers the surface, so it usually helps to drop the sea level afterwards to match.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="218"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>A final tweak to the heightmap is to smooth out the coastlines slightly. The</td></tr><tr><td class="line-number" value="219"></td><td class="line-content">erosion tends to produce quite rough terrain, which becomes tiny islands when</td></tr><tr><td class="line-number" value="220"></td><td class="line-content">cut off by sea level. A few of these can look good, but too many just looks</td></tr><tr><td class="line-number" value="221"></td><td class="line-content">messy. I repeatedly apply a filter where points which are below sea level, but</td></tr><tr><td class="line-number" value="222"></td><td class="line-content">a majority of whose neighbours are above sea level, get pulled up, and vice</td></tr><tr><td class="line-number" value="223"></td><td class="line-content">versa for points which are above sea level and have undersea neighbours. A</td></tr><tr><td class="line-number" value="224"></td><td class="line-content">couple of repeats of this produces a much cleaner coastline.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="225"></td><td class="line-content"><span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">example</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">erode</span>"&gt;</span></td></tr><tr><td class="line-number" value="226"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="227"></td><td class="line-content"><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="228"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="229"></td><td class="line-content"><span class="html-tag">&lt;h3&gt;</span>Rendering terrain<span class="html-tag">&lt;/h3&gt;</span></td></tr><tr><td class="line-number" value="230"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>Now comes the question of drawing the map (at least the physical portion). The</td></tr><tr><td class="line-number" value="231"></td><td class="line-content">easy part is the coastline - we've been doing this already. It's just a matter</td></tr><tr><td class="line-number" value="232"></td><td class="line-content">of drawing line segments where the heightmap crosses zero. There's not a lot</td></tr><tr><td class="line-number" value="233"></td><td class="line-content">extra to do about this.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="234"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>The next component is the rivers. We don't want to display the entire drainage</td></tr><tr><td class="line-number" value="235"></td><td class="line-content">network, because that would cover the whole map. Instead, we only show the</td></tr><tr><td class="line-number" value="236"></td><td class="line-content">drainage from points with above a certain threshold of water flux. By</td></tr><tr><td class="line-number" value="237"></td><td class="line-content">connecting these points to their downstream neighbours, we can trace out the</td></tr><tr><td class="line-number" value="238"></td><td class="line-content">river paths.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="239"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>One problem with this approach is that the rivers tend to zigzag from grid</td></tr><tr><td class="line-number" value="240"></td><td class="line-content">point to grid point, rather than following a smooth path. To solve this, I</td></tr><tr><td class="line-number" value="241"></td><td class="line-content">relax the points in the middle of the path towards their upstream and</td></tr><tr><td class="line-number" value="242"></td><td class="line-content">downstream neighbours (keeping the top and bottom fixed, so that intersections</td></tr><tr><td class="line-number" value="243"></td><td class="line-content">work properly). This smooths things out beautifully.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="244"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>The final part of this is the shading on the sides of hills, which helps</td></tr><tr><td class="line-number" value="245"></td><td class="line-content">indicate the topography. It is a central principle of cartography that we tend</td></tr><tr><td class="line-number" value="246"></td><td class="line-content">to interpret maps as though viewing the terrain from the bottom of the map,</td></tr><tr><td class="line-number" value="247"></td><td class="line-content">looking towards the top. So we want to draw strokes which go up and right if</td></tr><tr><td class="line-number" value="248"></td><td class="line-content">the terrain slopes upwards from left to right, and down and right if the</td></tr><tr><td class="line-number" value="249"></td><td class="line-content">terrain slopes downwards. Similarly, the strokes on the 'near' side of hills</td></tr><tr><td class="line-number" value="250"></td><td class="line-content">should be longer than those on the 'far' side.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="251"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>For each grid point, I calculate the slope, and ignore the point if it is less</td></tr><tr><td class="line-number" value="252"></td><td class="line-content">than a random threshold. For points which pass this test, I draw a short stroke</td></tr><tr><td class="line-number" value="253"></td><td class="line-content">with slope proportional to the horizontal component of the heightmap slope,</td></tr><tr><td class="line-number" value="254"></td><td class="line-content">with a small modifier for the vertical component. If the stroke would be too</td></tr><tr><td class="line-number" value="255"></td><td class="line-content">steep, I split it into several shorter strokes, at the maximum slope, drawn at</td></tr><tr><td class="line-number" value="256"></td><td class="line-content">random around the point.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="257"></td><td class="line-content"><span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">example</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">phys</span>"&gt;</span></td></tr><tr><td class="line-number" value="258"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="259"></td><td class="line-content"><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="260"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="261"></td><td class="line-content"><span class="html-tag">&lt;h3&gt;</span>Cities, borders<span class="html-tag">&lt;/h3&gt;</span></td></tr><tr><td class="line-number" value="262"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>Now that we have the 'physical' portion of the map sorted, we can move to</td></tr><tr><td class="line-number" value="263"></td><td class="line-content">looking at the 'political'. We want to place cities and towns on the map in</td></tr><tr><td class="line-number" value="264"></td><td class="line-content">feasible-looking locations. At the same time, we want the cities to be spread</td></tr><tr><td class="line-number" value="265"></td><td class="line-content">out enough that we can put labels on them without worrying too much about</td></tr><tr><td class="line-number" value="266"></td><td class="line-content">overlap.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="267"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>To place a city, I generate a score for each point, which is a combination of three things:<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="268"></td><td class="line-content"><span class="html-tag">&lt;ul&gt;</span></td></tr><tr><td class="line-number" value="269"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Water flux - we want cities to be preferentially located on rivers, so high water flux gets a bonus<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="270"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Distance from other cities - we want cities to be spread out, so penalize locations which are too close to an existing city<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="271"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Distance from the edge of the map - the other two criteria alone tend to push cities to the map edge, which isn't ideal, so penalize locations too close to the edge<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="272"></td><td class="line-content"><span class="html-tag">&lt;/ul&gt;</span></td></tr><tr><td class="line-number" value="273"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>Every time I add a city, I choose the point with the highest score, then</td></tr><tr><td class="line-number" value="274"></td><td class="line-content">recalculate the scores for all points. I make a distinction between cities,</td></tr><tr><td class="line-number" value="275"></td><td class="line-content">which have a 'region' associated with them, and towns, which don't. The cities</td></tr><tr><td class="line-number" value="276"></td><td class="line-content">are placed first, but otherwise there's no distinction in the code.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="277"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>The next step is to mark out the regions. We want the borders between regions</td></tr><tr><td class="line-number" value="278"></td><td class="line-content">to seem fairly reasonable, following natural borders like rivers and mountain</td></tr><tr><td class="line-number" value="279"></td><td class="line-content">ranges. The way I approach this is to expand regions outwards from each city,</td></tr><tr><td class="line-number" value="280"></td><td class="line-content">so that each region consists of the points which are 'closest' to its city,</td></tr><tr><td class="line-number" value="281"></td><td class="line-content">according to a particular distance measure. This distance measure is calculated</td></tr><tr><td class="line-number" value="282"></td><td class="line-content">by adding up the cost of the route, based on these criteria:<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="283"></td><td class="line-content"><span class="html-tag">&lt;ul&gt;</span></td></tr><tr><td class="line-number" value="284"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Horizontal distance<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="285"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Slope - uphill is much cheaper than downhill, so regions expand until they hit the top of ridges, then stop<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="286"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Water flux - crossing a river is expensive<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="287"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Shorelines - there is a large penalty for going from land to water (or vice versa), and a smaller penalty for travelling by water<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="288"></td><td class="line-content"><span class="html-tag">&lt;/ul&gt;</span></td></tr><tr><td class="line-number" value="289"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>Finally, the borders are drawn, using the same smoothing technique as the rivers.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="290"></td><td class="line-content"><span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">example</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">city</span>"&gt;</span></td></tr><tr><td class="line-number" value="291"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="292"></td><td class="line-content"><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="293"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="294"></td><td class="line-content"><span class="html-tag">&lt;h3&gt;</span>Placing labels<span class="html-tag">&lt;/h3&gt;</span></td></tr><tr><td class="line-number" value="295"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>At this point we can start naming things, using the process described in <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://mewo2.com/notes/naming-language/">/notes/naming-language/</a>"&gt;</span>these</td></tr><tr><td class="line-number" value="296"></td><td class="line-content">notes<span class="html-tag">&lt;/a&gt;</span>. I generate names for cities, towns and regions, using a</td></tr><tr><td class="line-number" value="297"></td><td class="line-content">consistent language for the whole map.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="298"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>The very last part of the process is to place the labels, avoiding overlaps,</td></tr><tr><td class="line-number" value="299"></td><td class="line-content">obscured cities, labels going off the edge of the map, etc. This sounds easy,</td></tr><tr><td class="line-number" value="300"></td><td class="line-content">but it really really isn't. Ideally, some sort of intelligent layout algorithm</td></tr><tr><td class="line-number" value="301"></td><td class="line-content">would place all the labels, rearranging as necessary. Instead, I have a few</td></tr><tr><td class="line-number" value="302"></td><td class="line-content">hundred lines of spaghetti code which seems to get the right answer most of the</td></tr><tr><td class="line-number" value="303"></td><td class="line-content">time, but which is packed full of magic numbers.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="304"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>In rough outline, what happens is this: the labels are placed in the order 1.</td></tr><tr><td class="line-number" value="305"></td><td class="line-content">cities, 2. towns, 3. regions. For cities and towns, there are four possible</td></tr><tr><td class="line-number" value="306"></td><td class="line-content">slots for the label, above, below, and to each side of the marker. Each label</td></tr><tr><td class="line-number" value="307"></td><td class="line-content">is placed, attempting to avoid the following overlaps (in rough order of</td></tr><tr><td class="line-number" value="308"></td><td class="line-content">importance):<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="309"></td><td class="line-content"><span class="html-tag">&lt;ul&gt;</span></td></tr><tr><td class="line-number" value="310"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>City markers<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="311"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Other city labels<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="312"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>The map edge<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="313"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Borders<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="314"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Coastlines<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="315"></td><td class="line-content"><span class="html-tag">&lt;li&gt;</span>Rivers<span class="html-tag">&lt;/li&gt;</span></td></tr><tr><td class="line-number" value="316"></td><td class="line-content"><span class="html-tag">&lt;/ul&gt;</span></td></tr><tr><td class="line-number" value="317"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>Obviously it's not usually possible to avoid all of these, so the least bad</td></tr><tr><td class="line-number" value="318"></td><td class="line-content">solution is chosen.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="319"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>For regions, there's a bit more freedom in where to place the label, but the</td></tr><tr><td class="line-number" value="320"></td><td class="line-content">labels are also bigger, and the map is more cluttered at this point. The</td></tr><tr><td class="line-number" value="321"></td><td class="line-content">scoring system rates positions based on proximity to the center of the region,</td></tr><tr><td class="line-number" value="322"></td><td class="line-content">as well as being over land, and penalties for all the overlaps mentioned</td></tr><tr><td class="line-number" value="323"></td><td class="line-content">before.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="324"></td><td class="line-content"><span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">example</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">final</span>"&gt;</span></td></tr><tr><td class="line-number" value="325"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>I wanted to make a nice interactive example for this, but trying to separate out the label placement code made me feel physically unwell. Sorry about that.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="326"></td><td class="line-content"><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="327"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="328"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>So that's the algorithm, at least in rough outline. The actual code running on</td></tr><tr><td class="line-number" value="329"></td><td class="line-content">the bot has a few other little bits and pieces, which honestly don't do much,</td></tr><tr><td class="line-number" value="330"></td><td class="line-content">but removing them is more trouble than it's worth when the code is working as</td></tr><tr><td class="line-number" value="331"></td><td class="line-content">it stands. The JavaScript code behind this page is available <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://github.com/mewo2/terrain">https://github.com/mewo2/terrain</a>"&gt;</span>on</td></tr><tr><td class="line-number" value="332"></td><td class="line-content">GitHub<span class="html-tag">&lt;/a&gt;</span>, and if you're really really brave you can look at the original</td></tr><tr><td class="line-number" value="333"></td><td class="line-content"><span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://github.com/mewo2/deserts">https://github.com/mewo2/deserts</a>"&gt;</span>Python code<span class="html-tag">&lt;/a&gt;</span> which was written while I was figuring all this out.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="334"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>There's obviously lots that could be done to improve this. Erosion is just one</td></tr><tr><td class="line-number" value="335"></td><td class="line-content">process, and the next obvious thing to add would be fluvial deposition, which</td></tr><tr><td class="line-number" value="336"></td><td class="line-content">would allow for flood plains, river deltas, etc to form. If you wanted more</td></tr><tr><td class="line-number" value="337"></td><td class="line-content">realistic mountains, then glacial processes would be worth looking at. Volcanic</td></tr><tr><td class="line-number" value="338"></td><td class="line-content">stuff could also be fun.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="339"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>On the graphical side, it could be fun to try to sketch more interesting</td></tr><tr><td class="line-number" value="340"></td><td class="line-content">textures on the map, such as forests or fields. Or you could fill the oceans</td></tr><tr><td class="line-number" value="341"></td><td class="line-content">with sea monsters and lost ships. If you're really brave, you could even look</td></tr><tr><td class="line-number" value="342"></td><td class="line-content">at labelling more features, like mountain ranges and rivers.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="343"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>As always, if you do any of these things, or make anything else interesting</td></tr><tr><td class="line-number" value="344"></td><td class="line-content">with this code or these ideas, please get in touch and let me know.<span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="345"></td><td class="line-content"><span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="http://mewo2.com/js/terraincontrols.js">/js/terraincontrols.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="346"></td><td class="line-content"><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="347"></td><td class="line-content"><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="348"></td><td class="line-content">        <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">footer</span>"&gt;</span></td></tr><tr><td class="line-number" value="349"></td><td class="line-content">            </td></tr><tr><td class="line-number" value="350"></td><td class="line-content"><span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">splash</span>"&gt;</span></td></tr><tr><td class="line-number" value="351"></td><td class="line-content">    <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://mewo2.com/">/</a>"&gt;</span>Home<span class="html-tag">&lt;/a&gt;</span> - <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://twitter.com/mewo2">https://twitter.com/mewo2</a>"&gt;</span>Contact me on Twitter<span class="html-tag">&lt;/a&gt;</span></td></tr><tr><td class="line-number" value="352"></td><td class="line-content"><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="353"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="354"></td><td class="line-content">        <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="355"></td><td class="line-content">        <span class="html-tag">&lt;script <span class="html-attribute-name">async</span> <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="http://platform.twitter.com/widgets.js">//platform.twitter.com/widgets.js</a>" <span class="html-attribute-name">charset</span>="<span class="html-attribute-value">utf-8</span>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="356"></td><td class="line-content">        <span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="357"></td><td class="line-content">            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){</td></tr><tr><td class="line-number" value="358"></td><td class="line-content">                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),</td></tr><tr><td class="line-number" value="359"></td><td class="line-content">            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)</td></tr><tr><td class="line-number" value="360"></td><td class="line-content">            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');</td></tr><tr><td class="line-number" value="361"></td><td class="line-content">            ga('create', 'UA-31259805-1', 'auto');</td></tr><tr><td class="line-number" value="362"></td><td class="line-content">            ga('send', 'pageview');</td></tr><tr><td class="line-number" value="363"></td><td class="line-content">        <span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="364"></td><td class="line-content">    <span class="html-tag">&lt;/body&gt;</span></td></tr><tr><td class="line-number" value="365"></td><td class="line-content"><span class="html-tag">&lt;/html&gt;</span><span class="html-end-of-file"></span></td></tr></tbody></table></body></html>
